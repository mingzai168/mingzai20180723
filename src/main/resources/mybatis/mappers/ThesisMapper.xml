<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.zttek.thesis.modules.mapper.ThesisMapper">
    <resultMap id="BaseResultMap" type="cn.zttek.thesis.modules.model.Thesis">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="orgid" property="orgid" jdbcType="BIGINT"/>
        <result column="projid" property="projid" jdbcType="BIGINT"/>
        <result column="topic" property="topic" jdbcType="VARCHAR"/>
        <result column="direction" property="direction" jdbcType="VARCHAR"/>
        <result column="source" property="source" jdbcType="VARCHAR"/>
        <result column="property" property="property" jdbcType="VARCHAR"/>
        <result column="checked" property="checked" jdbcType="BIT"/>
        <result column="teacherid" property="teacherid" jdbcType="BIGINT"/>
        <result column="studentid" property="studentid" jdbcType="BIGINT"/>
        <result column="viewerid" property="viewerid" jdbcType="BIGINT"/>
        <result column="uploadtime" property="uploadtime" jdbcType="TIMESTAMP"/>
        <result column="defensestatus" property="defensestatus" typeHandler="cn.zttek.thesis.common.mybatis.EnumHandler"/>
        <result column="valid" property="valid" jdbcType="BIT"/>
        <result column="cdate" property="cdate" jdbcType="TIMESTAMP"/>
        <result column="mdate" property="mdate" jdbcType="TIMESTAMP"/>
        <result column="profile" property="profile" jdbcType="LONGVARCHAR"/>
</resultMap>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        delete from thesis
        where id = #{id,jdbcType=BIGINT}
    </delete>
    <insert id="insert" parameterType="cn.zttek.thesis.modules.model.Thesis" useGeneratedKeys="true" keyProperty="id">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into thesis (orgid, projid, topic,
        direction, source, property,
        checked, teacherid, studentid,
        viewerid, uploadtime, defensestatus,
        valid, cdate, mdate,
        profile)
        values (#{orgid,jdbcType=BIGINT}, #{projid,jdbcType=BIGINT}, #{topic,jdbcType=VARCHAR},
        #{direction,jdbcType=VARCHAR}, #{source,jdbcType=VARCHAR}, #{property,jdbcType=VARCHAR},
        #{checked,jdbcType=BIT}, #{teacherid,jdbcType=BIGINT}, #{studentid,jdbcType=BIGINT},
        #{viewerid,jdbcType=BIGINT}, #{uploadtime,jdbcType=TIMESTAMP}, #{defensestatus,typeHandler=cn.zttek.thesis.common.mybatis.EnumHandler},
        #{valid,jdbcType=BIT}, #{cdate,jdbcType=TIMESTAMP}, #{mdate,jdbcType=TIMESTAMP},
        #{profile,jdbcType=LONGVARCHAR})
    </insert>
    <update id="updateByPrimaryKey" parameterType="cn.zttek.thesis.modules.model.Thesis">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update thesis
        set orgid = #{orgid,jdbcType=BIGINT},
        projid = #{projid,jdbcType=BIGINT},
        topic = #{topic,jdbcType=VARCHAR},
        direction = #{direction,jdbcType=VARCHAR},
        source = #{source,jdbcType=VARCHAR},
        property = #{property,jdbcType=VARCHAR},
        checked = #{checked,jdbcType=BIT},
        teacherid = #{teacherid,jdbcType=BIGINT},
        studentid = #{studentid,jdbcType=BIGINT},
        viewerid = #{viewerid,jdbcType=BIGINT},
        uploadtime = #{uploadtime,jdbcType=TIMESTAMP},
        defensestatus = #{defensestatus,typeHandler=cn.zttek.thesis.common.mybatis.EnumHandler},
        valid = #{valid,jdbcType=BIT},
        cdate = #{cdate,jdbcType=TIMESTAMP},
        mdate = #{mdate,jdbcType=TIMESTAMP},
        profile = #{profile,jdbcType=LONGVARCHAR}
        where id = #{id,jdbcType=BIGINT}
    </update>
    <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select id, orgid, projid, topic, profile, direction, source, property, checked, teacherid,
        studentid, viewerid, uploadtime, defensestatus, valid, cdate, mdate
        from thesis
        where id = #{id,jdbcType=BIGINT} and valid = 1
    </select>
    <select id="selectAll" resultMap="BaseResultMap">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select id, orgid, projid, topic, profile, direction, source, property, checked, teacherid,
        studentid, viewerid, uploadtime, defensestatus, valid, cdate, mdate
        from thesis where valid = 1
    </select>

    <!-- =========================以下为手动添加===================================== -->
    <sql id="Base_Column_List">
        id, orgid, projid, topic, profile, direction, source, property, checked, teacherid,
        studentid, viewerid, uploadtime, defensestatus, valid, cdate, mdate
    </sql>

    <sql id="condition">
        <if test="orgid != null">
            and t.orgid = #{orgid}
        </if>
        <if test="projid != null">
            and t.projid = #{projid}
        </if>
        <if test="teacherid != null">
            and t.teacherid = #{teacherid}
        </if>
        <if test="keywords != null and keywords != ''">
            and t.topic like CONCAT('%',#{keywords},'%')
        </if>
        <if test="checked != null">
            and t.checked = #{checked}
        </if>
        <if test="selected == true">
            and t.studentid = #{selected}
        </if>
        <if test="defensestatus != null">
            and t.defensestatus = #{defensestatus,typeHandler=cn.zttek.thesis.common.mybatis.EnumHandler}
        </if>
    </sql>

    <select id="listByOrg" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from thesis t where t.valid = 1
        <if test="orgid != null">
            and t.orgid = #{orgid}
        </if>
        <if test="teacherid != null">
            and t.teacherid = #{teacherid}
        </if>
        <if test="keywords != null and keywords != ''">
            and t.topic like CONCAT('%',#{keywords},'%')
        </if>
        order by t.mdate desc
    </select>

    <select id="listByProject" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from thesis t where t.valid = 1
        <if test="projid != null">
            and t.projid = #{projid}
        </if>
        <if test="teacherid != null">
            and t.teacherid = #{teacherid}
        </if>
        <if test="keywords != null and keywords != ''">
            and t.topic like CONCAT('%',#{keywords},'%')
        </if>
        order by t.mdate desc
    </select>

    <select id="getByTopic" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from thesis t where t.valid = 1 and t.topic = #{topic} and t.projid = #{projid}
    </select>
    <select id="getThesisCount" resultType="java.lang.Long">
        SELECT count(t.id) from thesis t where t.valid = 1 and t.projid = #{projid} and t.teacherid = #{teacherid}
    </select>

    <select id="getByStudent" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from thesis t where t.valid = 1 and t.studentid = #{studentid} and t.projid = #{projid}
    </select>
    
    <resultMap id="ThesisCount" type="cn.zttek.thesis.modules.expand.ThesisCountExpand">
        <result column="username" jdbcType="VARCHAR" property="username" />
        <result column="account" jdbcType="VARCHAR" property="account" />
        <result column="cnt" jdbcType="INTEGER" property="cnt"/>
    </resultMap>
    <select id="listThesisCount" resultMap="ThesisCount" >
        select u.username, u.account,
        (select count(t.id) from thesis t where t.valid = 1 and t.teacherid = u.id and t.projid = #{projid}) as cnt
        from user u, project_teacher pt
        where u.valid = 1 and u.id = pt.teacherid and pt.projectid = #{projid}
        <if test="keywords != null and keywords != ''">
            and (u.account like CONCAT('%',#{keywords},'%') or u.username like CONCAT('%',#{keywords},'%'))
        </if>
    </select>
    <!--<select id="listThesisByCheck" resultMap="BaseResultMap">
      select t.id, t.topic, t.direction, t.source, t.property, t.checked, t.teacherid,
        t.studentid, u.username as profile
      from thesis t, user u
      where t.projid = #{projid} and  t.teacherid = u.id  and t.valid = 1 and u.valid = 1
      <if test="checked != null">
          t.checked = #{checked}
      </if>
      <if test="keywords != null and keywords != ''">
          and (u.account like CONCAT('%',#{keywords},'%') or u.username like CONCAT('%',#{keywords},'%'))
      </if>
    </select>-->
    <!--使用视图查询-->
    <select id="listThesisByCheck" resultMap="BaseResultMap">
        select t.id, t.topic, t.direction, t.source, t.property, t.checked, t.teacherid,
        t.studentid, t.username as profile
        from thesis_teacher t
        where t.projid = #{projid}
        <if test="checked != null">
            and t.checked = #{checked}
        </if>
        <if test="keywords != null and keywords != ''">
            and (t.account like CONCAT('%',#{keywords},'%') or t.username like CONCAT('%',#{keywords},'%'))
        </if>
    </select>


    <update id="saveCheck">
        update thesis t
        set t.checked = #{isCheck}
        where t.id in
        (
            <foreach collection="tids" item="tid" index="index" separator="," >
                #{tid}
            </foreach>
        )
    </update>

    
    <resultMap id="TeacherResultMap" type="cn.zttek.thesis.modules.model.Thesis" extends="BaseResultMap">
        <result column="username" jdbcType="VARCHAR" property="teacher" />
    </resultMap>
    <select id="listNotSelected" resultMap="TeacherResultMap">
        select tt.id,  tt.orgid, tt.projid, tt.topic, tt.teacherid, tt.direction, tt.source, tt.property, tt.username
        from  thesis_teacher tt
        where tt.projid = #{projid}
        and tt.studentid is null and tt.checked = true
        <if test="teacherid != null">
            and tt.teacherid = #{teacherid}
        </if>
        <if test="keywords != null and keywords != ''">
            and tt.topic like CONCAT('%',#{keywords},'%')
        </if>
    </select>



    <select id="listByTeacher" resultMap="cn.zttek.thesis.modules.mapper.ThesisExpandMapper.ThesisExpand">
        select ts.id, ts.topic, ts.teacherid, ts.studentid, ts.account as stuno, ts.username as stuname, s.id as scoreid,
        s.mark3 as mark, ts.viewerid
        from thesis_student ts LEFT JOIN score s on ts.id = s.thesisid
        where ts.teacherid = #{teacherid} and ts.projid = #{projid}
    </select>


</mapper>